# Feature : Tracker de Heath(Model / Table)

### 💡 Spécification Tracker Santé

### **Épique : Tracker de Santé**

---

### **`User Stories`**

### **1. Visualisation des Données de Santé**

**En tant qu'utilisateur**

Je veux voir un tableau de bord de mes données de santé

Afin de suivre mon état de santé global

**Critères d'Acceptation** :

- [ ] Affichage d'un graphique des calories, poids et temps par jour
- [ ] Affichage d'un tableau des entrées de santé (calories, poids, temps)
- [ ] Filtrage par semaine et mois
- [ ] Mise en évidence des tendances (progression, stagnation, régression)

**`Definition of Done`** :

- Interface responsive
- Tests utilisateurs validés
- Performance < 2s pour le chargement

---

### **2. Gestion des Entrées de Santé**

**En tant qu'utilisateur**

Je veux gérer mes entrées de données de santé

Afin de maintenir un suivi précis de mes progrès

**Critères d'Acceptation** :

- [ ] Création d'une nouvelle entrée (calories, poids, temps)
- [ ] Modification d'une entrée existante
- [ ] Suppression d'une entrée
- [ ] Catégorisation (par activité ou objectif, par exemple sport, alimentation)

**`Definition of Done`** :

- Validation des données
- Mise à jour en temps réel du tableau de bord
- Confirmation des actions critiques

---

### **3. Analyse Graphique**

**En tant qu'utilisateur**

Je veux visualiser mes données sous forme de graphique

Afin d’analyser mes tendances de santé

**Critères d'Acceptation** :

- [ ] Graphique linéaire journalier ou hebdomadaire
- [ ] Agrégation automatique par jour/semaine
- [ ] Légende interactive
- [ ] Tooltips informatifs

---

### **4. Navigation et Pagination**

**En tant qu'utilisateur**

Je veux naviguer facilement dans mes données

Afin de retrouver rapidement les informations recherchées

**Critères d'Acceptation** :

- [ ] Pagination par 10 éléments
- [ ] Sélecteur de semaines et mois
- [ ] Tri par date ou catégorie
- [ ] Indicateur de chargement

---

### **Product Backlog Items (PBI)**

### **1. Sécurité et Accès**

**Priorité** : Haute

**Estimation** : 8 points

- Authentification utilisateur
- Autorisation CRUD
- Protection des données personnelles

---

### **2. Interface Graphique**

**Priorité** : Haute

**Estimation** : 13 points

- Composant graphique
- Tableau de données
- Formulaires CRUD
- Design responsive

---

### **3. Gestion des Données**

**Priorité** : Haute

**Estimation** : 8 points

- Modèle de données pour calories, poids, temps
- Agrégation journalière et hebdomadaire
- Pagination
- Filtres

---

### **4. Performance**

**Priorité** : Moyenne

**Estimation** : 5 points

- Optimisation des requêtes
- Mise en cache
- Chargement progressif

---

### **Risques et Dépendances**

### **Risques**

- Performance avec grand volume de données
- Complexité des calculs d'agrégation
- Expérience utilisateur sur mobile

### **Dépendances**

- Système d'authentification
- Base de données performante
- Bibliothèque de graphiques

---

### **Métriques de Succès**

- Temps de chargement < 2s
- Satisfaction utilisateur > 4/5
- Taux d'erreur < 1%
- Adoption > 80% des utilisateurs cibles

---

### **Planning Agile**

### **Sprint 1 (1 semaine)**

- Modélisation des données
- CRUD des entrées de santé
- Interface basique (Table)

### **Sprint 2 (1 semaine)**

- Graphiques
- Agrégations

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Nous allons faire la même chose que précédemment pour `Finance` mais avec `Heath`

- Modélisation de `Heath`

```tsx
export const healthCategoryEnum = pgEnum('health_category', [
  'calories',
  'poids',
  'temps',
])

export const health = pgTable('health', {
  id: uuid('id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  value: integer('value').notNull(),
  date: timestamp('date', {withTimezone: true}).notNull(),
  category: healthCategoryEnum('category').notNull(),
  userId: uuid('userId')
    .notNull()
    .references(() => users.id, {onDelete: 'cascade'}),
})
```

- Repository `Heath`
  - CRUD de base
- Service `Heath`
  - CRUD de base + Autorisation de base

Comme c’est 80% identique pour la partie tableau, les exercices se concentrent sur les différences, le reste sera fourni.

## Exercice

Une différence majeure par rapport à la feature `Finance`, est que nous avons en plus des années, une agrégation par semaine. Nous voulons pouvoir tracker ce qu’un utilisateur a fait sur une semaine du lundi au dimanche de la semaine X. Exemple :

- Lundi : Poids : 80 Kilos | Sport : 2 heures | Calories : 2000k
- Mardi : Poids : 81 Kilos | Sport : 1 heures | Calories : 2200k
- etc …

Les 2 grandes fonctions majeures à adapter / créer sont :

- `getHealthsWithPaginationByWeekDao` : Les `heaths` par année et semaine pour un `user`
- `getWeeksHealthsByYearDao` : Les `weeks` par `année` où des données sont disponibles. Les semaines disponibles pourront être insérées dans un second `<Select>` pour avoir par exemple les données du
  - 2025 : Semaine du ‘28-07 au 03-08’

**🐶 Implémente ces 2 fonctions de `repository Health`**

💡 Astuce pour `getHealthsWithPaginationByWeekDao` : `Postgrees` permet de filtrer par année comme cela

```tsx
EXTRACT(YEAR FROM ${date}) = "2025"` //match avec les date de 2025
```

Pour filtrer par semaine, il est possible de faire :

```tsx
EXTRACT(WEEK FROM ${date}) = 52 // match avec les 52ème semaine de l'année
```

Nous verrons plus tard comment convertir `‘28-07 au 03-08’` en numéro de `week`

Doc : [https://neon.tech/postgresql/postgresql-date-functions/postgresql-extract](https://neon.tech/postgresql/postgresql-date-functions/postgresql-extract)

💡 Astuce pour `getWeeksHealthsByYearDao` :

- Filtrer par `année` pour un `user`
- Concaténer avec [CONCAT](https://neon.tech/postgresql/postgresql-string-functions/postgresql-concat-function#summary)
- Obtenir le lundi avec [DATE_TRUNC(’week’)](https://neon.tech/postgresql/postgresql-date-functions/postgresql-date_trunc#summary)
- Obtenir le dimanche avec [`DATE(... + INTERVAL '6 day')`](https://neon.tech/postgresql/postgresql-tutorial/postgresql-interval)

```tsx
date_trunc('week', ${health.date}) //Donne le premier jour de la semaine de la date
TO_CHAR(..., 'DD-MM') // Formate la date en format "DD-MM"
DATE(... + INTERVAL '6 day') //Ajoute 6 jours à la date de début pour obtenir la fin de semaine (dimanche)
```

Pour éviter les doublons :

```tsx
.selectDistinct({
      week: sql<string>`<SQL REQUETE>`.as(
        'week'
      ),
    })
```

Fichiers

- `data/repositories/health-repository.ts`

## Bonus

### 1. 🚀 Filtrer par semaine : `Select`

Pour filtrer par semaine, la première chose à faire est d’ajouter un `queryParam` : `healthWeek` à la route `/heath`, par exemple :

- `/health?healthWeek=28-07+au+03-08`

Dans un second temps, il va falloir convertir cette chaine ‘`28-07+au+03-08`’ en numéro de semaine dans l’année. Pour cela, tu as à ta disposition `getWeekFromLabel`

```tsx
export const getWeekFromLabel = (label: string, year: string) => {
  // Extrait les 5 premiers caractères du label (format "DD-MM" depuis "DD-MM+au+DD-MM")
  const week = label.slice(0, 5)
  // Décompose la chaîne "DD-MM" en jour et mois
  const [day, month] = week.split('-')
  // Crée un objet Date à partir du jour, mois et année
  // Format attendu par parse: "YYYY-MM-DD"
  const parsedDate = parse(
    `${year}-${month}-${Number(day)}`,  // Construit la chaîne de date complète
    'yyyy-MM-dd',                        // Spécifie le format de la date
    new Date()                           // Date de référence (fallback)
  )
  // Calcule le numéro de la semaine (1-53) pour la date donnée
  const startWeek = getWeek(parsedDate)
  return startWeek
}
```

- 🐶 Dans un premier temps, adapte la route (`app/(app)/health/page`) pour avoir les bons params et faire les bons appels aux services
- 🐶 Dans un second temps, occupe-toi du `Select Year Week` (`health-year-select.tsx`)
  - Ajoute un deuxième select pour les `weeks`
  - Change les `queryParams` lors d’un changement d’item dans le select
  ```tsx
  //exemple
  const params = new URLSearchParams(searchParams)
  params.set("param", "value")
  router.push(`${pathname}?${params.toString()}`, {scroll: false})
  ```

Fichiers

- `app/(app)/health/page`
- `acomponent/dashboard/tracker/heath/health-year-select.tsx`

## Aller plus loin

📑 Le lien vers la doc [https://neon.tech/postgresql/postgresql-tutorial/](https://neon.tech/postgresql/postgresql-tutorial)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=06%20feature-health-crud).
