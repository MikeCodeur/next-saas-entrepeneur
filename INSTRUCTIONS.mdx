# Optimisation SSG

### 💡 Optimiser le rendu

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Un `build` nous montre que presque tout est en dynamique.

- C’est OK pour certaines pages comme le `dashboard`, `account` ,`health`, `finance`
- Mais pourquoi `/privacy` `/terms`, etc. le sont-elles ?
- Peut-on optimiser le rendu des pages publiques ?

```html
Route (app) Size First Load JS ┌ ƒ / 3.44 kB 153 kB ├ ○ /_not-found 990 B 107 kB
├ ƒ /account 6.91 kB 144 kB ├ ƒ /api/auth/[...nextauth] 153 B 106 kB ├ ƒ
/dashboard 4.94 kB 245 kB ├ ○ /error 2.33 kB 120 kB ├ ƒ /finance 1.45 kB 321 kB
├ ƒ /health 1.7 kB 317 kB ├ ƒ /instructions 5.5 kB 112 kB ├ ƒ /logout 2.07 kB
120 kB ├ ƒ /privacy 153 B 106 kB ├ ƒ /public 1.56 kB 165 kB ├ ƒ
/public/[id]/finance 1.45 kB 321 kB ├ ƒ /public/[id]/health 1.7 kB 317 kB ├ ƒ
/restricted 175 B 110 kB ├ ƒ /settings 3.15 kB 117 kB ├ ○ /sign-in 3.04 kB 120
kB ├ ○ /sign-up 3.19 kB 121 kB ├ ƒ /terms 153 B 106 kB └ ○ /verify-request 153 B
106 kB + First Load JS shared by all 106 kB ├
chunks/1e75e89c-8aa0a1685f3aec44.js 53.4 kB ├ chunks/5996-a50e9f761cee33ed.js 51
kB └ other shared chunks (total) 1.97 kB
```

## Exercice

L’optimisation des routes publiques a un layout en commun `PublicLayout` qui contient un `<Header />` avec du code dépendant des cookies `nextauth`. Cela rend automatiquement la page dynamique.

```tsx
const session = await auth()
```

Il s’agit ici de faire un compromis entre performance et fonctionnalité.

- Avoir l’information du user connecté ou non → Perte du rendu statique sur toutes les pages publiques avec ce layout.

Faisons le choix de perdre cette information et d’avoir un maximum de pages publiques statiques.

- **🐶** Crée une copie du `<Header>` que l’on appellera `<StaticHeader>` , un composant ne contenant pas d’appel à `auth()` et utilisons le dans le `layout` des pages publiques.

`/privacy` et `/terms` devraient redevenir `static`

Fichiers

- `/app/(public)/layout.tsx`
- `/components/layout/static-header.tsx`

## Bonus

### 1. 🚀 Optimisation liste des users publics

Il n’est pas possible de rendre cette route statique ou mise en cache avec `revalidate` à cause des `queryParam`

```tsx
export const revalidate = 3600
```

Ce qui est couteux est l’appel aux données en base de données.

- Ces données `sont mises en cache` dans le `DAL` avec `React Cache`

```tsx
import {cache} from 'react'

export const getPublicUsersDal = cache(
  async (page: number, pageSize: number) => {
    return await getPublicUsersWithPagination(page, pageSize)
  }
)
// nous avons mis une latence dans 'getPublicUsersWithPagination'
// await new Promise((resolve) => setTimeout(resolve, 5000))
```

Malheureusement, `React Cache` ne fonctionne qu’au niveau `“Request“` (Si, lors d’une requête serveur, plusieurs appels à `getPublicUsersDal` sont faits)

Mais lors d’une nouvelle requête serveur, le cache est invalide.

L’API Next nous propose une solution pour mettre en cache des données.

- [https://nextjs.org/docs/app/api-reference/functions/unstable_cache](https://nextjs.org/docs/app/api-reference/functions/unstable_cache) `unstable_cache`

```tsx
import { getUser } from './data';
import { unstable_cache } from 'next/cache';

const getCachedUser = unstable_cache(
  async (id) => getUser(id),
  ['my-app-user']
);

export default async function Component({ userID }) {
  const user = await getCachedUser(userID);
  ...
}
```

💡 Cette `unstable fonction` sera remplacée par `“use cache”` mais ce n’est pas encore officiel.

- [https://nextjs.org/docs/app/api-reference/directives/use-cache](https://nextjs.org/docs/app/api-reference/directives/use-cache)

**🐶** Dans cet exercice, tu vas devoir mettre en cache les utilisateurs publics (`getPublicUsersDal`) pendant 1 heure avec \*\*\*\*`unstable_cache`.

Fichiers

- `/app/(public)/public/page.tsx`

### 2. 🚀 SSG public fiance/heath by user

Step 1 : **🐶**La première étape est de rendre le `layout LayoutPublicUserId` SSG avec `generateStaticParams`

```tsx
//app/(public)/public/[id]/layout.tsx
export const generateStaticParams = async () => {
  const users = await getPublicUsersDal(1, 100)
  return ...
}
```

Step 2 : **🐶 Les routes**

On ne peut pas rendre SSG car il y a des `queryParam`

```tsx
type SearchParams = Promise<{
  financeYear?: string
  page?: string
  pageSize?: string
}>

type Params = Promise<{
  id?: string
}>
```

Une piste possible serait de les supprimer et de garder uniquement la `route param (id)` et en gérant les `queryParam` uniquement dans des composants clients. De cette manière, nous pourrions avoir une page initiale statique et des chargements si les params changent.

```tsx
'use client'
const searchParams = useSearchParams()
const financeYear = searchParams.get('financeYear')
const page = searchParams.get('page')
const pageSize = searchParams.get('pageSize')
```

⚠️ Sauf que ! Il faudrait s’assurer qu’il n’y a aucun appel à une `dynamique function` (headers, cookies, `nextauth`, etc…). Or, tous nos appels aux services sont protégés par une autorisation dépendant de `nextAuth`

- Solution : Exposer des services/DAL spéciaux sans `auth` pour avoir des données publiques utilisables par le SSG. (un peu long….)

Nous allons ici plutôt essayer d’utiliser `nextCache` sur les fonctions couteuses.

```tsx
import { unstable_cache } from 'next/cache';
const getCachedUsers = nextCache(
    async () => getYearsFinancesByUid(userId),
    [`getYearsFinancesByUid-${userId}`],
    {revalidate: 3600}
  )
```

Mais toujours des erreurs

```tsx
 Error: Route /public/[id]/finance used "headers" inside a function cached
  with "unstable_cache(...)".
  Accessing Dynamic data sources inside a cache scope is not supported.
  If you need this data inside a cached function use "headers"
  outside of the cached function and pass the required dynamic data in as
   an argument. See more info here:
   https://nextjs.org/docs/app/api-reference/functions/unstable_cache
```

La seule solution : Exposer des services/DAL spéciaux sans auth

Fichiers

- `/app/(public)/public/[id]/layout.tsx`

## Aller plus loin

📑 Le lien vers la doc [https://nextjs.org/docs/app/api-reference/functions/unstable_cache](https://nextjs.org/docs/app/api-reference/functions/unstable_cache)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=16%20optimisation%20ssg).
