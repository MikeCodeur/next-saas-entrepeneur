# Role Based Access Control

### 💡 Mettre en place `RBAC`

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans une application, il est important de gérer l’autorisation (`AuthZ`) . Cela permet de répondre à la question :

- Cet utilisateur a t-il le droit de faire telle action ?
- Exemple : Le User avec le `Role Admin` peut t-il supprimer une donnée ?

Pour le moment, nous avons quelques règles simples basées sur le `Role`

- Si `admin`, on peut tout faire ; sinon (`user`), l’accès est refusé.

```tsx
// Si le user est admin il peut supprimer une finance
export const canDeleteFinance = async () => {
  const authUser = await getUserAuthExtented()
  const hasRoleAdmin = idAdmin(authUser?.user)
  if (hasRoleAdmin) return true
  return false
}
```

Mais dans une application complexe, on peut avoir besoin de gérer encore plus de financements :

- ressources
- actions
- attributs
- etc…

Et il devient vite compliqué d’implémenter toutes ces règles et de les maintenir. Des services tiers ou des librairies nous permettent de gérer cela.

Pour l’exercice, nous allons utiliser une simple librairie : `accesscontrol`. Elle fonctionne comme ceci : Exemple

```tsx
let grantList = [
    { role: 'admin', resource: 'video', action: 'create:any', attributes: '*, !views' },
    { role: 'admin', resource: 'video', action: 'read:any', attributes: '*' },
    { role: 'admin', resource: 'video', action: 'update:any', attributes: '*, !views' },
    { role: 'admin', resource: 'video', action: 'delete:any', attributes: '*' },

    { role: 'user', resource: 'video', action: 'create:own', attributes: '*, !rating, !views' },
    { role: 'user', resource: 'video', action: 'read:any', attributes: '*' },
    { role: 'user', resource: 'video', action: 'update:own', attributes: '*, !rating, !views' },
    { role: 'user', resource: 'video', action: 'delete:own', attributes: '*' }
];
const ac = new AccessControl(grantList);

const permission = ac.can('user').createOwn('video');
console.log(permission.granted);    // —> true
console.log(permission.attributes); // —> ['*'] (all attributes)

permission = ac.can('admin').updateAny('video');
console.log(permission.granted);    // —> true
console.log(permission.attributes); // —> ['title']
```

Une fois mise en place dans notre code, il nous suffit de modifier cette configuration (au lieu de modifier du code)

## Exercice

**🐶** Dans cet exercice, tu vas devoir utiliser `accesscontrol` pour gérer le `RBAC`.

Etape 1 : configuration

- `rbac-config.ts`
- Définis la configuration pour les rôles `admin`, `user` et `public`.
- Pour chaque rôle, configure la `ressource`, `l’action` et les `attributs`, par exemple

```tsx
const grantAdminList= [
  //admin peut creer et lire n'importe quel finance
  {role: 'admin', resource: 'finance', action: 'create:any', attributes: '*'},
  {role: 'admin', resource: 'finance', action: 'read:any', attributes: '*'},
  //user peut creer et lire ses propres données
  const grantUserList = [
  {role: 'user', resource: 'finance', action: 'read:own', attributes: '*'},
  {role: 'user', resource: 'finance', action: 'create:own', attributes: '*'},

  const ac = new AccessControl([
  ...grantAdminList,
  ...grantUserList,
])
```

Etape 2 : Utilisation

Nous avons créé un service générique “`authorization`” qui va gérer le `RBAC`. L’idée est de pouvoir appeler une fonction `permissionAcces` qui appellera Access control de la manière suivante :

```tsx
export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()

  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  return permission?.granted
}
```

```tsx
export const permissionAcces = (
  user: User | undefined,
  ressourceType: Ressource,
  action: GrantAction,
  ressourceUid?: string
) => {
  ac.can('admin').readAny('finance')
```

Etape 3 : Utilisation de `permissionAcces`

Utilise `permissionAcces` dans chaque service d’autorisation spécifique comme `finance-authorization`

```tsx
export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()
  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  return permission.granted
}
```

Fichiers

- `services/authorization/rbac-config.ts`
- `services/authorization/authorization-service.ts`
- `services/authorization/finance-authorization.ts`

## Bonus

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=11%20RBAC).
