# Mettre en place les tests avec Vitest

### ğŸ’¡ Description longue de l'exercice

## ğŸ“ Tes notes

Detaille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Pour utiliser les tests dans notre projets nous avons ajoutÃ© les dÃ©pendances suivantes

```tsx
"devDependencies": {
  // Packages principaux de test
  "@testing-library/jest-dom": "^6.6.3",
  "@testing-library/react": "^16.1.0",
  "@testing-library/user-event": "^14.5.2",
  "@vitejs/plugin-react": "^4.3.4",
  "@vitest/coverage-v8": "^1.6.0",
  "vitest": "^1.6.0",
  "jsdom": "^26.0.0",

  // Plugins ESLint pour les tests
  "eslint-plugin-testing-library": "^6.5.0",
  "eslint-plugin-vitest": "^0.5.4",

  // Configuration des chemins pour les tests
  "vite-tsconfig-paths": "^4.3.2",
}
```

- Nous avons crÃ©er un fichier de configuration `vitest`

```tsx
//vitest.config.ts
import {defineConfig} from 'vitest/config'
import react from '@vitejs/plugin-react'
import tsconfigPaths from 'vite-tsconfig-paths'

export default defineConfig({
  plugins: [react(), tsconfigPaths()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/__tests__/setup-test.ts'],
    include: ['**/*.test.{ts,tsx}'],
    alias: {
      '@/*': './src/*',
    },
  },
})

```

ğŸ“‘ Le liens vers la doc [https://vitest.dev/](https://vitest.dev/)

Un test de composant React simple est dÃ©jÃ  en place pour vÃ©rifier que lâ€™environnement de test sâ€™exÃ©cute

```tsx
describe('app', () => {
  it('render title home page with `Plateforme de tracker pour les entrepreneur`', () => {
    render(<Home />)
    const text = screen.getByText(
      /plateforme de tracker pour les entrepreneur/i
    )
    expect(text).toBeInTheDocument()
  })
})
```

- Il faut lancer la commande : `pnpm test`
- Si tout est ok

```tsx

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  10:53:48
   Duration  162ms
```

## Exercice

Dans cet exercice tu vas devoir tester une des parties les plus importante de lâ€™application, la `couche service.`

En appelant des fonctions du services cela va utiliser la validation, lâ€™autorisation et les repository.

- Nous allons `mocker` les repositories (qui peuvent Ãªtre testÃ© sÃ©parÃ©ment) exemp

```tsx
vi.mock('@/data/repositories/user-repository', () => ({
  createUserDao: vi.fn(),
  ...
}))
//valeur du mock
beforeEach(() => {
    vi.clearAllMocks()
    vi.mocked(userRepository.getUserByIdDao).mockResolvedValue(userTest)
  })
```

- Nous allons rÃ©diger des jeux de tests pour sâ€™assurer que les cas fonctionnels liÃ© au RBAC sont respectÃ©
-

**ğŸ¶ Dans un premier temps commence par les test du services user (CRUD) avec diffÃ©rents rÃ´les (USER ADMIN PUBLIC)**

- Nous avons a notre disposition `setupUserAuthExtented`, qui permet de simuler lâ€™utilisateur connectÃ©. Ce sera utile pour chaque test

```tsx
setupUserAuthExtented({user: userTest})
```

Les tests sont `skip` pour le moment pour les activer supprime le `skip`

```tsx
it.skip("[USER] devrait ...")
it("[USER] devrait ...")
```

TestÂ qu'un utilisateur connectÃ© peut voir son propre profil

- TestÂ qu'un utilisateur connectÃ© peut voir son propre profil
- Test qu'un utilisateur ne peut pas voir le profil privÃ© d'un autre utilisateur
- Test qu'un administrateur peut voir leÂ profil de n'importe quelÂ utilisateur
- Test qu'un visiteur peut voir un profil public
- Test qu'un visiteur ne peut pas voirÂ un profil privÃ©
- Test qu'un utilisateur connectÃ© peut modifier son propre profil
- Test qu'unÂ utilisateur ne peut pas modifier le profil d'un autre utilisateur
- Test qu'un administrateur peut modifier n'importeÂ quel profil
- Test qu'un visiteur ne peut pas modifier un profil public
- Test qu'un visiteur ne peut pas modifier un profil privÃ©

Fichiers

- `services/__tests__/user-service.test.ts`

## Bonus

### 1. ğŸš€ Test finance

- **ğŸ¶ Test finance**

Tests pour le service finance :

- Test qu'un utilisateur peut crÃ©er une financeÂ pour son propre compte
- Test qu'unÂ utilisateur ne peut pas crÃ©er une finance pourÂ un autre utilisateur
- Test qu'un administrateurÂ peut crÃ©er une finance pour n'importeÂ quel utilisateur
- Test qu'un utilisateur peut voir ses propres finances
- Test qu'un utilisateur ne peut pasÂ voir les finances d'un autre utilisateur
- Test qu'un administrateur peut voirÂ les finances de tous les utilisateurs
- Test qu'unÂ utilisateur peut modifier ses propres finances
- Test qu'un utilisateur ne peut pasÂ modifier les finances d'un autre utilisateur
- Test qu'un administrateur peut modifierÂ les finances de n'importe quel utilisateur
- TestÂ qu'un utilisateur peut supprimer sesÂ propres finances
- Test qu'unÂ utilisateur ne peut pas supprimer les financesÂ d'un autre utilisateur
- Test qu'un administrateurÂ peut supprimer les finances de n'importe quel utilisateur

Fichiers

- `services/__tests__/finance-service.test.ts`

### 2. ğŸš€ Test SantÃ©

La mÃªme chose pour santÃ©

Test qu'un utilisateur peut crÃ©er une donnÃ©e de santÃ© pour son propre compte

- Test qu'un utilisateur peut crÃ©er une donnÃ©e de santÃ© pour son propre compte
- Test qu'un utilisateur ne peutÂ pas crÃ©er une donnÃ©e de santÃ© pourÂ un autre utilisateur
- Test qu'un administrateur peut crÃ©er une donnÃ©e deÂ santÃ© pour n'importe quel utilisateur
- Test qu'un utilisateurÂ peut voir ses propres donnÃ©es de santÃ©
- Test qu'un utilisateur ne peut pas voir les donnÃ©es deÂ santÃ© d'un autre utilisateur

6. Test qu'un administrateur peut voir les donnÃ©es de santÃ© deÂ tous les utilisateurs

- Test qu'un utilisateur peut modifier ses propres donnÃ©es de santÃ©
- Test qu'un utilisateur ne peut pas modifierÂ les donnÃ©es de santÃ© d'un autre utilisateur
- Test qu'un administrateurÂ peut modifier les donnÃ©es de santÃ© de n'importe quel utilisateur
- TestÂ qu'un utilisateur peut supprimer sesÂ propres donnÃ©es de santÃ©
- TestÂ qu'un utilisateur ne peut pas supprimer les donnÃ©es de santÃ© d'un autreÂ utilisateur
- Test qu'un administrateur peut supprimer les donnÃ©es de santÃ©Â de n'importe quel utilisateur

Fichiers

- `src/services/__tests__/health-service.test.ts`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://vitest.dev/](https://vitest.dev/)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=8.SAAS%20Entrepreneur&entry.533578441=15-tests-rbac).
