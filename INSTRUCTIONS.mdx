# Mettre en place les tests avec Vitest

### 💡 Description longue de l'exercice

## 📝 Tes notes

Detaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Pour utiliser les tests dans notre projets nous avons ajouté les dépendances suivantes

```tsx
"devDependencies": {
  // Packages principaux de test
  "@testing-library/jest-dom": "^6.6.3",
  "@testing-library/react": "^16.1.0",
  "@testing-library/user-event": "^14.5.2",
  "@vitejs/plugin-react": "^4.3.4",
  "@vitest/coverage-v8": "^1.6.0",
  "vitest": "^1.6.0",
  "jsdom": "^26.0.0",

  // Plugins ESLint pour les tests
  "eslint-plugin-testing-library": "^6.5.0",
  "eslint-plugin-vitest": "^0.5.4",

  // Configuration des chemins pour les tests
  "vite-tsconfig-paths": "^4.3.2",
}
```

- Nous avons créer un fichier de configuration `vitest`

```tsx
//vitest.config.ts
import {defineConfig} from 'vitest/config'
import react from '@vitejs/plugin-react'
import tsconfigPaths from 'vite-tsconfig-paths'

export default defineConfig({
  plugins: [react(), tsconfigPaths()],
  test: {
    environment: 'jsdom',
    setupFiles: ['./src/__tests__/setup-test.ts'],
    include: ['**/*.test.{ts,tsx}'],
    alias: {
      '@/*': './src/*',
    },
  },
})

```

📑 Le liens vers la doc [https://vitest.dev/](https://vitest.dev/)

Un test de composant React simple est déjà en place pour vérifier que l’environnement de test s’exécute

```tsx
describe('app', () => {
  it('render title home page with `Plateforme de tracker pour les entrepreneur`', () => {
    render(<Home />)
    const text = screen.getByText(
      /plateforme de tracker pour les entrepreneur/i
    )
    expect(text).toBeInTheDocument()
  })
})
```

- Il faut lancer la commande : `pnpm test`
- Si tout est ok

```tsx

 Test Files  1 passed (1)
      Tests  1 passed (1)
   Start at  10:53:48
   Duration  162ms
```

## Exercice

Dans cet exercice tu vas devoir tester une des parties les plus importante de l’application, la `couche service.`

En appelant des fonctions du services cela va utiliser la validation, l’autorisation et les repository.

- Nous allons `mocker` les repositories (qui peuvent être testé séparément) exemp

```tsx
vi.mock('@/data/repositories/user-repository', () => ({
  createUserDao: vi.fn(),
  ...
}))
//valeur du mock
beforeEach(() => {
    vi.clearAllMocks()
    vi.mocked(userRepository.getUserByIdDao).mockResolvedValue(userTest)
  })
```

- Nous allons rédiger des jeux de tests pour s’assurer que les cas fonctionnels lié au RBAC sont respecté
-

**🐶 Dans un premier temps commence par les test du services user (CRUD) avec différents rôles (USER ADMIN PUBLIC)**

- Nous avons a notre disposition `setupUserAuthExtented`, qui permet de simuler l’utilisateur connecté. Ce sera utile pour chaque test

```tsx
setupUserAuthExtented({user: userTest})
```

Les tests sont `skip` pour le moment pour les activer supprime le `skip`

```tsx
it.skip("[USER] devrait ...")
it("[USER] devrait ...")
```

Test qu'un utilisateur connecté peut voir son propre profil

- Test qu'un utilisateur connecté peut voir son propre profil
- Test qu'un utilisateur ne peut pas voir le profil privé d'un autre utilisateur
- Test qu'un administrateur peut voir le profil de n'importe quel utilisateur
- Test qu'un visiteur peut voir un profil public
- Test qu'un visiteur ne peut pas voir un profil privé
- Test qu'un utilisateur connecté peut modifier son propre profil
- Test qu'un utilisateur ne peut pas modifier le profil d'un autre utilisateur
- Test qu'un administrateur peut modifier n'importe quel profil
- Test qu'un visiteur ne peut pas modifier un profil public
- Test qu'un visiteur ne peut pas modifier un profil privé

Fichiers

- `services/__tests__/user-service.test.ts`

## Bonus

### 1. 🚀 Test finance

- **🐶 Test finance**

Tests pour le service finance :

- Test qu'un utilisateur peut créer une finance pour son propre compte
- Test qu'un utilisateur ne peut pas créer une finance pour un autre utilisateur
- Test qu'un administrateur peut créer une finance pour n'importe quel utilisateur
- Test qu'un utilisateur peut voir ses propres finances
- Test qu'un utilisateur ne peut pas voir les finances d'un autre utilisateur
- Test qu'un administrateur peut voir les finances de tous les utilisateurs
- Test qu'un utilisateur peut modifier ses propres finances
- Test qu'un utilisateur ne peut pas modifier les finances d'un autre utilisateur
- Test qu'un administrateur peut modifier les finances de n'importe quel utilisateur
- Test qu'un utilisateur peut supprimer ses propres finances
- Test qu'un utilisateur ne peut pas supprimer les finances d'un autre utilisateur
- Test qu'un administrateur peut supprimer les finances de n'importe quel utilisateur

Fichiers

- `services/__tests__/finance-service.test.ts`

### 2. 🚀 Test Santé

La même chose pour santé

Test qu'un utilisateur peut créer une donnée de santé pour son propre compte

- Test qu'un utilisateur peut créer une donnée de santé pour son propre compte
- Test qu'un utilisateur ne peut pas créer une donnée de santé pour un autre utilisateur
- Test qu'un administrateur peut créer une donnée de santé pour n'importe quel utilisateur
- Test qu'un utilisateur peut voir ses propres données de santé
- Test qu'un utilisateur ne peut pas voir les données de santé d'un autre utilisateur

6. Test qu'un administrateur peut voir les données de santé de tous les utilisateurs

- Test qu'un utilisateur peut modifier ses propres données de santé
- Test qu'un utilisateur ne peut pas modifier les données de santé d'un autre utilisateur
- Test qu'un administrateur peut modifier les données de santé de n'importe quel utilisateur
- Test qu'un utilisateur peut supprimer ses propres données de santé
- Test qu'un utilisateur ne peut pas supprimer les données de santé d'un autre utilisateur
- Test qu'un administrateur peut supprimer les données de santé de n'importe quel utilisateur

Fichiers

- `src/services/__tests__/health-service.test.ts`

## Aller plus loin

📑 Le lien vers la doc [https://vitest.dev/](https://vitest.dev/)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=8.SAAS%20Entrepreneur&entry.533578441=15-tests-rbac).
