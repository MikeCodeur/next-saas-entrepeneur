# Gérer les profils publics

### 💡 Mettre en place les profils publiques

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans l’application, il y a une `feature` d’affichage des profils publics pour les utilisateurs qui souhaitent partager leurs performances. Pour cela les utilisateur doivent passer leur compte en public (`user.visibility`) . Pour cela, nous avons à notre disposition dans le repository une fonction qui permet de faire cela : `getPublicUsersWithPaginationDao`, elle est remontée au `user-service` et ensuite au `user-dal`

```tsx

export const getPublicUsersWithPaginationDao = async (pagination: {
  limit: number
  offset: number
}) => {
  const [rows, [{count}]] = await Promise.all([
    db
      .select()
      .from(users)
      .where(eq(users.visibility, 'public'))
      .limit(pagination.limit)
      .offset(pagination.offset),
    db
      .select({count: sql<number>`count(*)`})
      .from(users)
      .where(eq(users.visibility, 'public')),
  ])
  return {
    data: rows.length === 0 ? [] : rows,
    pagination: {
      rowCount: count,
      pageSize: pagination.limit,
    },
  }
}
```

Pour gagner du temps, les routes suivantes sont déjà créées :

- `/public`
- `/public/[id]/finance`
- `/public/[id]/heath`

Mais elles n’affichent aucune donnée.

## Exercice

**🐶** Dans un premier temps, utilise `getPublicUsersDal` pour afficher la liste des utilisateurs publics et les afficher dans un tableau.

Note : Le tableau contient une définition des colonnes avec un lien pour visualiser les données d’un utilisateur.

```tsx

//public-columns.tsx
export const publicColumns: ColumnDef<Partial<User>>[] = [
  {
    accessorKey: 'name',
    header: ({column}) => <DataTableColumnHeader column={column} title="Nom" />,
    cell: ({row}) => {
      const name = row.getValue('name') as string
      return (
        <Link
          className="min-w-fit text-left hover:cursor-pointer md:w-[200px]"
          href={`/public/${row.original.id}/finance`}
        >
          {name}
        </Link>
      )
    },
    filterFn: (row, name, value) => {
      return value.includes(row.getValue(name))
    },
  },
]
```

Note : Le lien devrait générer une erreur si aucun utilisateur n’est connecté, nous allons résoudre cela dans l’exercice suivant.

Fichiers

- `/app/(public)/public/page.tsx`

## Bonus

### 1. 🚀 Gérer les ressources publiques

Le lien vers public finance (en mode déconnecté) devrait générer une erreur car nous essayons d’accéder à des données `Finance` donc l’appel à `canReadFinance`

```tsx
export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()
  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  return permission.granted
}
```

Quand il n’y a pas d’utilisateur connecté, l’`accesscontrol` suivant est activé

```tsx
return ac.can('public').readAny('finance')
//or nous permettons pas à n'importe qui de read les finance
// et nous allons pas l'authoriser dans les regles generiques
```

Par contre, nous allons ajouter une spécificité dans le service `finance authorisation`

- On check `permissionAcces` (si jamais un admin veut lire un user privé)
- Et si pas d’accès, on vérifie le champ `visibility`
- Si public, on autorise

```tsx

export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()
  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  const userToRead = await getUserByIdDao(resourceUid)

  const isPublic = userToRead?.visibility === 'public'
  const isGranted = permission?.granted

  if (isPublic || isGranted) return true
  return false
}
```

- **🐶** Implémente cela dans **`finance-authorization`**

Fichiers

- `/services/authorization/finance-authorization.ts`

### 2. 🚀 Redirection `/restricted`

Maintenant que nous protégeons correctement notre route, nous allons gérer l’erreur
`GrantedError()` et rediriger vers une page `/restricted`

- **🐶** Adapte la route \*\*\*\*`/finance/page.tsx`

Fichiers

- `/(public)/public/[id]/(trackers)/finance/page.tsx`

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=12%20public-profil).
