# Next-Auth Resend

### ğŸ’¡ Utiliser `Resend`

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les exercices prÃ©cÃ©dents, nous avons utilisÃ© `next-auth` avec le mode `Credentials` (login / password) comme fournisseur. Cependant, ce mode est de moins en moins recommandÃ© en raison des pratiques de sÃ©curitÃ© actuelles.

Dans ce module, nous allons utiliser **`Resend`**, un service qui permet Ã  la fois :

- **L'envoi d'e-mails** dans notre SaaS,
- Et **la gestion de l'authentification** via l'envoi d'un lien magique pour une connexion sÃ©curisÃ©e.

Pour rappel, `Next-Auth` est toujours utilisÃ© avec `Drizzle` comme `adapter`, et le model est dÃ©jÃ  crÃ©Ã© pour simplifier lâ€™exercice car nous lâ€™avons dÃ©jÃ  fait dans les modules prÃ©cÃ©dents.

- [https://authjs.dev/getting-started/adapters/drizzle](https://authjs.dev/getting-started/adapters/drizzle)

Nous allons maintenant configurer le provider `Resend`

- [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

Pour cela il faut :

- Ouvrir un compte gratuit [https://resend.com/](https://resend.com/) et
- CrÃ©er une clef API [https://resend.com/api-keys](https://resend.com/api-keys)

La mettre dans `.env.developpement`

```bash
#.env.developpement
RESEND_API_KEY="re_xxxxxxxxxx"
```

DÃ©pendances :

- `"@auth/drizzle-adapter": "^1.7.4",`
- `"resend": "^4.0.1",`

Note : Pense Ã  bien nettoyer tes `cookies` et `localstorage` pour bien dÃ©marrer les exercices

ğŸ“‘ Le lien vers la doc [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

## Exercice

- **ğŸ¶** Dans un premier temps, tu vas devoir configurer le provider `Resend` dans `Next-Auth` de la maniÃ¨re suivante dans `auth-config.ts`:

```tsx
import NextAuth from "next-auth"
import Resend from "next-auth/providers/resend"

export const { handlers, auth, signIn, signOut } = NextAuth({
   providers: [
    ResendProvider({
      apiKey: process.env.RESEND_API_KEY,
      sendVerificationRequest: async ({identifier: email, url}) => {
        const fromEmail = process.env.EMAIL_FROM

        if (!fromEmail) {
          throw new Error('EMAIL_FROM is not set')
        }
        const {error} = await resend.emails.send({
          to: email,
          subject: 'Connexion sur la plateforme Tracker Entrepeneur',
          from: fromEmail,
          html: `<p>Bonjour lien de connextion ${url}</p>`,
        })
        if (error) {
          console.error('Error sending email', error)
          throw error
        }
      },
    }),
  ],
```

Note : `EMAIL_FROM` et `EMAIL_TO` doivent Ãªtre des emails vÃ©rifiÃ©s en termes de domaine (ou lâ€™email du compte `resend`) pour que lâ€™email soit envoyÃ©. Pour le mode test, nous utiliserons : `onboarding@resend.dev`

```bash
#.env.developpement
EMAIL_FROM="onboarding@resend.dev"
```

Pense Ã  bien configurer lâ€™`adapter` `nextauth`

```tsx
session: {
    strategy: 'database',
  },
  adapter: DrizzleAdapter(db),
```

- **ğŸ¶** Dans un second temps, tu vas pouvoir utiliser la fonction `sign-in` de `next-auth` avec le `provider resend` dans les `actions` de `sign-in` et `sign-up`

```tsx
const result = await signIn('resend', {
  email: request.email,
  redirect: false,
})
```

- **ğŸ¶** La 3Ã¨me Ã©tape, consiste Ã  aller dans lâ€™interface de [Resend](https://resend.com/emails) et cliquer sur le lien de lâ€™email reÃ§u aprÃ¨s le `sign-in` (ou copier coller dans url).

Ce lien est un lien vers un api route `next-auth`

```tsx
export {GET, POST} from '@/services/authentication/auth-service'
```

Quelques emails dÃ©jÃ  en base de donnÃ©es

- [`admin@gmail.com`](mailto:admin@gmail.com) (rÃ´le `admin`)
- `user@gmail.com`(rÃ´le `user`)

Fichiers

- `services/authentication/auth-config.ts`
- `app/(auth)/sign-in/action`
- `app/(auth)/sign-up/action`
- `app/api/[...nextauth]/route.ts`

## Bonus

### 1. ğŸš€ CrÃ©er une page `verify-request` custom

Dans lâ€™exercice prÃ©cÃ©dent, nous sommes redirigÃ©s vers la page `verify-request` par dÃ©faut de `next-auth`

```tsx
if (result) {
  redirect(result)
}
```

**ğŸ¶ Dans cet exercice,** tu vas devoir nous rediriger uniquement si `result` contient `error` (exemple `/api/auth/error?error=Configuration`)

et Ã  la fin, rediriger vers notre propre route qui existe dÃ©jÃ  (`redirect('/verify-request')`)

- [http://localhost:3000/verify-request](http://localhost:3000/verify-request)

Fichiers

- `app/(auth)/sign-in/action`
- `app/(auth)/sign-up/action`

### 2. ğŸš€ ProtÃ©ger les routes avec un HOC

Pour cela, nous utiliserons un HOC `withAuth` comme nous lâ€™avons fait dans les modules prÃ©cÃ©dents.

**ğŸ¶** ProtÃ¨ge lâ€™accÃ¨s aux routes du `dashboard` avec `withAuth`

Fichiers

- `app/(app)/dashboard/layout`

### 3. ğŸš€ Redirection vers le dashboard

Par dÃ©faut, lâ€™url envoyÃ©e par email est la page en cours (`sign-in`). Nous allons ici rediriger vers `Dashboard`

- **ğŸ¶P**our cela, adapte la config `next-auth`

```tsx
 callbacks: {
    async redirect({url, baseUrl}) {
      return `${baseUrl}/dashboard`
    },
  },
```

Fichiers

- `services/authentication/auth-config.ts`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=02%20Next-Auth-Resend).
