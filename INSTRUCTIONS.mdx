# Next-Auth Resend

### 💡 Utiliser `Resend`

## 📝 Tes notes

Détaille ce que tu as appris ici, sur une page [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans les exercices précédents, nous avons utilisé `next-auth` avec le mode `Credentials` (login / password) comme fournisseur. Cependant, ce mode est de moins en moins recommandé en raison des pratiques de sécurité actuelles.

Dans ce module, nous allons utiliser **`Resend`**, un service qui permet à la fois :

- **L'envoi d'e-mails** dans notre SaaS,
- Et **la gestion de l'authentification** via l'envoi d'un lien magique pour une connexion sécurisée.

Pour rappel, `Next-Auth` est toujours utilisé avec `Drizzle` comme `adapter`, et le model est déjà créé pour simplifier l’exercice car nous l’avons déjà fait dans les modules précédents.

- [https://authjs.dev/getting-started/adapters/drizzle](https://authjs.dev/getting-started/adapters/drizzle)

Nous allons maintenant configurer le provider `Resend`

- [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

Pour cela il faut :

- Ouvrir un compte gratuit [https://resend.com/](https://resend.com/) et
- Créer une clef API [https://resend.com/api-keys](https://resend.com/api-keys)

La mettre dans `.env.developpement`

```bash
#.env.developpement
RESEND_API_KEY="re_xxxxxxxxxx"
```

Dépendances :

- `"@auth/drizzle-adapter": "^1.7.4",`
- `"resend": "^4.0.1",`

Note : Pense à bien nettoyer tes `cookies` et `localstorage` pour bien démarrer les exercices

📑 Le lien vers la doc [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

## Exercice

- **🐶** Dans un premier temps, tu vas devoir configurer le provider `Resend` dans `Next-Auth` de la manière suivante dans `auth-config.ts`:

```tsx
import NextAuth from "next-auth"
import Resend from "next-auth/providers/resend"

export const { handlers, auth, signIn, signOut } = NextAuth({
   providers: [
    ResendProvider({
      apiKey: process.env.RESEND_API_KEY,
      sendVerificationRequest: async ({identifier: email, url}) => {
        const fromEmail = process.env.EMAIL_FROM

        if (!fromEmail) {
          throw new Error('EMAIL_FROM is not set')
        }
        const {error} = await resend.emails.send({
          to: email,
          subject: 'Connexion sur la plateforme Tracker Entrepeneur',
          from: fromEmail,
          html: `<p>Bonjour lien de connextion ${url}</p>`,
        })
        if (error) {
          console.error('Error sending email', error)
          throw error
        }
      },
    }),
  ],
```

Note : `EMAIL_FROM` et `EMAIL_TO` doivent être des emails vérifiés en termes de domaine (ou l’email du compte `resend`) pour que l’email soit envoyé. Pour le mode test, nous utiliserons : `onboarding@resend.dev`

```bash
#.env.developpement
EMAIL_FROM="onboarding@resend.dev"
```

Pense à bien configurer l’`adapter` `nextauth`

```tsx
session: {
    strategy: 'database',
  },
  adapter: DrizzleAdapter(db),
```

- **🐶** Dans un second temps, tu vas pouvoir utiliser la fonction `sign-in` de `next-auth` avec le `provider resend` dans les `actions` de `sign-in` et `sign-up`

```tsx
const result = await signIn('resend', {
  email: request.email,
  redirect: false,
})
```

- **🐶** La 3ème étape, consiste à aller dans l’interface de [Resend](https://resend.com/emails) et cliquer sur le lien de l’email reçu après le `sign-in` (ou copier coller dans url).

Ce lien est un lien vers un api route `next-auth`

```tsx
export {GET, POST} from '@/services/authentication/auth-service'
```

Quelques emails déjà en base de données

- [`admin@gmail.com`](mailto:admin@gmail.com) (rôle `admin`)
- `user@gmail.com`(rôle `user`)

Fichiers

- `services/authentication/auth-config.ts`
- `app/(auth)/sign-in/action`
- `app/(auth)/sign-up/action`
- `app/api/[...nextauth]/route.ts`

## Bonus

### 1. 🚀 Créer une page `verify-request` custom

Dans l’exercice précédent, nous sommes redirigés vers la page `verify-request` par défaut de `next-auth`

```tsx
if (result) {
  redirect(result)
}
```

**🐶 Dans cet exercice,** tu vas devoir nous rediriger uniquement si `result` contient `error` (exemple `/api/auth/error?error=Configuration`)

et à la fin, rediriger vers notre propre route qui existe déjà (`redirect('/verify-request')`)

- [http://localhost:3000/verify-request](http://localhost:3000/verify-request)

Fichiers

- `app/(auth)/sign-in/action`
- `app/(auth)/sign-up/action`

### 2. 🚀 Protéger les routes avec un HOC

Pour cela, nous utiliserons un HOC `withAuth` comme nous l’avons fait dans les modules précédents.

**🐶** Protège l’accès aux routes du `dashboard` avec `withAuth`

Fichiers

- `app/(app)/dashboard/layout`

### 3. 🚀 Redirection vers le dashboard

Par défaut, l’url envoyée par email est la page en cours (`sign-in`). Nous allons ici rediriger vers `Dashboard`

- **🐶P**our cela, adapte la config `next-auth`

```tsx
 callbacks: {
    async redirect({url, baseUrl}) {
      return `${baseUrl}/dashboard`
    },
  },
```

Fichiers

- `services/authentication/auth-config.ts`

## Aller plus loin

📑 Le lien vers la doc [https://authjs.dev/getting-started/providers/resend](https://authjs.dev/getting-started/providers/resend)

## Ils vont t’aider

- **🐶 Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **🤖 Ash le Robot** : _Ash le Robot te donnera du code utile._
- **🚀 Julia La roquette** : _Julia te donnera des défis supplémentaires._
- **⛏️ Hulk le Marteau** : _Quand du code à supprimer est présent_
- **👨‍✈️ Hugo le chef de projet** : _Va t'aider sur les spécifications du projet_

## 🐜 Feedback

Remplir le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=02%20Next-Auth-Resend).
