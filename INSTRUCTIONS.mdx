# GÃ©rer les profils publics

### ğŸ’¡ Mettre en place les profils publiques

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Dans lâ€™application, il y a une `feature` dâ€™affichage des profils publics pour les utilisateurs qui souhaitent partager leurs performances. Pour cela les utilisateur doivent passer leur compte en public (`user.visibility`) . Pour cela, nous avons Ã  notre disposition dans le repository une fonction qui permet de faire cela : `getPublicUsersWithPaginationDao`, elle est remontÃ©e au `user-service` et ensuite au `user-dal`

```tsx

export const getPublicUsersWithPaginationDao = async (pagination: {
  limit: number
  offset: number
}) => {
  const [rows, [{count}]] = await Promise.all([
    db
      .select()
      .from(users)
      .where(eq(users.visibility, 'public'))
      .limit(pagination.limit)
      .offset(pagination.offset),
    db
      .select({count: sql<number>`count(*)`})
      .from(users)
      .where(eq(users.visibility, 'public')),
  ])
  return {
    data: rows.length === 0 ? [] : rows,
    pagination: {
      rowCount: count,
      pageSize: pagination.limit,
    },
  }
}
```

Pour gagner du temps, les routes suivantes sont dÃ©jÃ  crÃ©Ã©es :

- `/public`
- `/public/[id]/finance`
- `/public/[id]/heath`

Mais elles nâ€™affichent aucune donnÃ©e.

## Exercice

**ğŸ¶** Dans un premier temps, utilise `getPublicUsersDal` pour afficher la liste des utilisateurs publics et les afficher dans un tableau.

Note : Le tableau contient une dÃ©finition des colonnes avec un lien pour visualiser les donnÃ©es dâ€™un utilisateur.

```tsx

//public-columns.tsx
export const publicColumns: ColumnDef<Partial<User>>[] = [
  {
    accessorKey: 'name',
    header: ({column}) => <DataTableColumnHeader column={column} title="Nom" />,
    cell: ({row}) => {
      const name = row.getValue('name') as string
      return (
        <Link
          className="min-w-fit text-left hover:cursor-pointer md:w-[200px]"
          href={`/public/${row.original.id}/finance`}
        >
          {name}
        </Link>
      )
    },
    filterFn: (row, name, value) => {
      return value.includes(row.getValue(name))
    },
  },
]
```

Note : Le lien devrait gÃ©nÃ©rer une erreur si aucun utilisateur nâ€™est connectÃ©, nous allons rÃ©soudre cela dans lâ€™exercice suivant.

Fichiers

- `/app/(public)/public/page.tsx`

## Bonus

### 1. ğŸš€ GÃ©rer les ressources publiques

Le lien vers public finance (en mode dÃ©connectÃ©) devrait gÃ©nÃ©rer une erreur car nous essayons dâ€™accÃ©der Ã  des donnÃ©es `Finance` donc lâ€™appel Ã  `canReadFinance`

```tsx
export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()
  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  return permission.granted
}
```

Quand il nâ€™y a pas dâ€™utilisateur connectÃ©, lâ€™`accesscontrol` suivant est activÃ©

```tsx
return ac.can('public').readAny('finance')
//or nous permettons pas Ã  n'importe qui de read les finance
// et nous allons pas l'authoriser dans les regles generiques
```

Par contre, nous allons ajouter une spÃ©cificitÃ© dans le service `finance authorisation`

- On check `permissionAcces` (si jamais un admin veut lire un user privÃ©)
- Et si pas dâ€™accÃ¨s, on vÃ©rifie le champ `visibility`
- Si public, on autorise

```tsx

export const canReadFinance = async (resourceUid: string) => {
  const authUser = await getUserAuthExtented()
  const permission = permissionAcces(
    authUser?.user,
    'finance',
    'read',
    resourceUid
  )
  const userToRead = await getUserByIdDao(resourceUid)

  const isPublic = userToRead?.visibility === 'public'
  const isGranted = permission?.granted

  if (isPublic || isGranted) return true
  return false
}
```

- **ğŸ¶** ImplÃ©mente cela dans **`finance-authorization`**

Fichiers

- `/services/authorization/finance-authorization.ts`

### 2. ğŸš€ Redirection `/restricted`

Maintenant que nous protÃ©geons correctement notre route, nous allons gÃ©rer lâ€™erreur
`GrantedError()` et rediriger vers une page `/restricted`

- **ğŸ¶** Adapte la route \*\*\*\*`/finance/page.tsx`

Fichiers

- `/(public)/public/[id]/(trackers)/finance/page.tsx`

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=12%20public-profil).
