# Optimisation SSG

### ğŸ’¡ Optimiser le rendu

## ğŸ“ Tes notes

DÃ©taille ce que tu as appris ici,Â surÂ uneÂ pageÂ [Notion](https://go.mikecodeur.com/course-notes-template)

## Comprendre

Un `build` nous montre que presque tout est en dynamique.

- Câ€™est OK pour certaines pages comme le `dashboard`, `account` ,`health`, `finance`
- Mais pourquoi `/privacy` `/terms`, etc. le sont-elles ?
- Peut-on optimiser le rendu des pages publiques ?

```html
Route (app) Size First Load JS â”Œ Æ’ / 3.44 kB 153 kB â”œ â—‹ /_not-found 990 B 107 kB
â”œ Æ’ /account 6.91 kB 144 kB â”œ Æ’ /api/auth/[...nextauth] 153 B 106 kB â”œ Æ’
/dashboard 4.94 kB 245 kB â”œ â—‹ /error 2.33 kB 120 kB â”œ Æ’ /finance 1.45 kB 321 kB
â”œ Æ’ /health 1.7 kB 317 kB â”œ Æ’ /instructions 5.5 kB 112 kB â”œ Æ’ /logout 2.07 kB
120 kB â”œ Æ’ /privacy 153 B 106 kB â”œ Æ’ /public 1.56 kB 165 kB â”œ Æ’
/public/[id]/finance 1.45 kB 321 kB â”œ Æ’ /public/[id]/health 1.7 kB 317 kB â”œ Æ’
/restricted 175 B 110 kB â”œ Æ’ /settings 3.15 kB 117 kB â”œ â—‹ /sign-in 3.04 kB 120
kB â”œ â—‹ /sign-up 3.19 kB 121 kB â”œ Æ’ /terms 153 B 106 kB â”” â—‹ /verify-request 153 B
106 kB + First Load JS shared by all 106 kB â”œ
chunks/1e75e89c-8aa0a1685f3aec44.js 53.4 kB â”œ chunks/5996-a50e9f761cee33ed.js 51
kB â”” other shared chunks (total) 1.97 kB
```

## Exercice

Lâ€™optimisation des routes publiques a un layout en commun `PublicLayout` qui contient un `<Header />` avec du code dÃ©pendant des cookies `nextauth`. Cela rend automatiquement la page dynamique.

```tsx
const session = await auth()
```

Il sâ€™agit ici de faire un compromis entre performance et fonctionnalitÃ©.

- Avoir lâ€™information du user connectÃ© ou non â†’ Perte du rendu statique sur toutes les pages publiques avec ce layout.

Faisons le choix de perdre cette information et dâ€™avoir un maximum de pages publiques statiques.

- **ğŸ¶** CrÃ©e une copie du `<Header>` que lâ€™on appellera `<StaticHeader>` , un composant ne contenant pas dâ€™appel Ã  `auth()` et utilisons le dans le `layout` des pages publiques.

`/privacy` et `/terms` devraient redevenir `static`

Fichiers

- `/app/(public)/layout.tsx`
- `/components/layout/static-header.tsx`

## Bonus

### 1. ğŸš€ Optimisation liste des users publics

Il nâ€™est pas possible de rendre cette route statique ou mise en cache avec `revalidate` Ã  cause des `queryParam`

```tsx
export const revalidate = 3600
```

Ce qui est couteux est lâ€™appel aux donnÃ©es en base de donnÃ©es.

- Ces donnÃ©es `sont mises en cache` dans le `DAL` avec `React Cache`

```tsx
import {cache} from 'react'

export const getPublicUsersDal = cache(
  async (page: number, pageSize: number) => {
    return await getPublicUsersWithPagination(page, pageSize)
  }
)
// nous avons mis une latence dans 'getPublicUsersWithPagination'
// await new Promise((resolve) => setTimeout(resolve, 5000))
```

Malheureusement, `React Cache` ne fonctionne quâ€™au niveau `â€œRequestâ€œ` (Si, lors dâ€™une requÃªte serveur, plusieurs appels Ã  `getPublicUsersDal` sont faits)

Mais lors dâ€™une nouvelle requÃªte serveur, le cache est invalide.

Lâ€™API Next nous propose une solution pour mettre en cache des donnÃ©es.

- [https://nextjs.org/docs/app/api-reference/functions/unstable_cache](https://nextjs.org/docs/app/api-reference/functions/unstable_cache) `unstable_cache`

```tsx
import { getUser } from './data';
import { unstable_cache } from 'next/cache';

const getCachedUser = unstable_cache(
  async (id) => getUser(id),
  ['my-app-user']
);

export default async function Component({ userID }) {
  const user = await getCachedUser(userID);
  ...
}
```

ğŸ’¡ Cette `unstable fonction` sera remplacÃ©e par `â€œuse cacheâ€` mais ce nâ€™est pas encore officiel.

- [https://nextjs.org/docs/app/api-reference/directives/use-cache](https://nextjs.org/docs/app/api-reference/directives/use-cache)

**ğŸ¶** Dans cet exercice, tu vas devoir mettre en cache les utilisateurs publics (`getPublicUsersDal`) pendant 1 heure avec \*\*\*\*`unstable_cache`.

Fichiers

- `/app/(public)/public/page.tsx`

### 2. ğŸš€ SSG public fiance/heath by user

Step 1 : **ğŸ¶**La premiÃ¨re Ã©tape est de rendre le `layout LayoutPublicUserId` SSG avec `generateStaticParams`

```tsx
//app/(public)/public/[id]/layout.tsx
export const generateStaticParams = async () => {
  const users = await getPublicUsersDal(1, 100)
  return ...
}
```

Step 2 : **ğŸ¶ Les routes**

On ne peut pas rendre SSG car il y a des `queryParam`

```tsx
type SearchParams = Promise<{
  financeYear?: string
  page?: string
  pageSize?: string
}>

type Params = Promise<{
  id?: string
}>
```

Une piste possible serait de les supprimer et de garder uniquement la `route param (id)` et en gÃ©rant les `queryParam` uniquement dans des composants clients. De cette maniÃ¨re, nous pourrions avoir une page initiale statique et des chargements si les params changent.

```tsx
'use client'
const searchParams = useSearchParams()
const financeYear = searchParams.get('financeYear')
const page = searchParams.get('page')
const pageSize = searchParams.get('pageSize')
```

âš ï¸ Sauf que ! Il faudrait sâ€™assurer quâ€™il nâ€™y a aucun appel Ã  une `dynamique function` (headers, cookies, `nextauth`, etcâ€¦). Or, tous nos appels aux services sont protÃ©gÃ©s par une autorisation dÃ©pendant de `nextAuth`

- Solution : Exposer des services/DAL spÃ©ciaux sans `auth` pour avoir des donnÃ©es publiques utilisables par le SSG. (un peu longâ€¦.)

Nous allons ici plutÃ´t essayer dâ€™utiliser `nextCache` sur les fonctions couteuses.

```tsx
import { unstable_cache } from 'next/cache';
const getCachedUsers = nextCache(
    async () => getYearsFinancesByUid(userId),
    [`getYearsFinancesByUid-${userId}`],
    {revalidate: 3600}
  )
```

Mais toujours des erreurs

```tsx
 Error: Route /public/[id]/finance used "headers" inside a function cached
  with "unstable_cache(...)".
  Accessing Dynamic data sources inside a cache scope is not supported.
  If you need this data inside a cached function use "headers"
  outside of the cached function and pass the required dynamic data in as
   an argument. See more info here:
   https://nextjs.org/docs/app/api-reference/functions/unstable_cache
```

La seule solution : Exposer des services/DAL spÃ©ciaux sans auth

Fichiers

- `/app/(public)/public/[id]/layout.tsx`

## Aller plus loin

ğŸ“‘ Le lien vers la doc [https://nextjs.org/docs/app/api-reference/functions/unstable_cache](https://nextjs.org/docs/app/api-reference/functions/unstable_cache)

## Ils vont tâ€™aider

- **ğŸ¶ Mowgli le Chien** : _Mowgli te guidera dans chaque exercice._
- **ğŸ¤– Ash le Robot** : _Ash le Robot te donnera du code utile._
- **ğŸš€ Julia La roquette** : _Julia te donnera des dÃ©fis supplÃ©mentaires._
- **â›ï¸ Hulk le Marteau** : _Quand du code Ã  supprimer est prÃ©sent_
- **ğŸ‘¨â€âœˆï¸ Hugo le chef de projet** : _Va t'aider sur les spÃ©cifications du projet_

## ğŸœ Feedback

Remplir le formulaire le [formulaire de FeedBack](https://go.mikecodeur.com/cours-next-avis?entry.1912869708=Next%20Mastery&entry.1430994900=9.SAAS%20Entrepreneur&entry.533578441=16%20optimisation%20ssg).
